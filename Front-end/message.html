<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UCL Chat â€¢ Bootstrap</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #002147, #004080);
      }
      .app-shell {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: 100dvh;
        max-width: 980px;
        margin: 0 auto;
        border-radius: 20px;
        overflow: hidden;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      }
      .app-header {
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      .chat-scroll { overflow-y: auto; padding: 1rem; }
      .msg { display: flex; gap: .75rem; margin-bottom: .75rem; }
      .avatar { width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; color: #fff; }
      .bubble { padding: .75rem .9rem; border-radius: 16px; background: rgba(255,255,255,.1); color: #fff; max-width: 70%; }
      .msg.user { justify-content: flex-end; }
      .msg.user .bubble { background: #004080; }
      .composer { background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.1); }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <div class="app-shell">
        <!-- Header -->
        <header class="app-header px-3 py-2 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-light">UCL Chat</h5>
          <button id="clearHistory" class="btn btn-sm btn-outline-light">
            <i class="bi bi-trash"></i> Clear
          </button>
        </header>

        <!-- Chat Body -->
        <main id="chat" class="chat-scroll"></main>

        <!-- Composer -->
        <footer class="composer p-3">
          <div class="row g-2">
            <div class="col-10">
              <textarea id="message" class="form-control" rows="1" placeholder="Type a message..."></textarea>
            </div>
            <div class="col-2 d-grid">
              <button id="sendBtn" class="btn btn-primary">
                <i class="bi bi-send"></i>
              </button>
            </div>
          </div>
        </footer>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>




      const API_BASE = "http://localhost:8000/api"; // Laravel API base
      const TOKEN = "YOUR_BEARER_TOKEN";            // Replace with real token from login



      async function fetchProduct(id) {
              try {
                const res = await fetch(`${API_URL}/products/${id}`);
                if (!res.ok) throw new Error("Product not found");
                const p = await res.json();

                document.getElementById("product-name").textContent =
                  p.name || "Unnamed Product";
                document.getElementById("product-description").textContent =
                  p.description || "No description available.";
                document.getElementById("product-category").textContent =
                  p.category || "N/A";
                document.getElementById("product-condition").textContent = p.is_used
                  ? "Used"
                  : "New";
                document.getElementById("product-price").textContent = `$${
                  p.price || "N/A"
                }`;
                document.getElementById("product-seller").textContent = `Sold by: ${
                  p.user ? p.user.name : "Unknown Seller"
                }`;

                // Set product image if available
                if (p.images) {
                  document.getElementById(
                    "product-image"
                  ).src = `http://127.0.0.1:8000${p.images}`;
                } else {
                  // Placeholder image if none available
                  document.getElementById("product-image").src =
                    "https://via.placeholder.com/800x600?text=No+Image+Available";
                }

                // Check if user is the owner
                const currentUserId = localStorage.getItem("user_id");
                if (
                  p.user &&
                  currentUserId &&
                  parseInt(currentUserId) === p.user.id
                ) {
                  document.getElementById("add-to-cart").style.display = "none";
                  document.getElementById("add-to-wishlist").style.display = "none";
                  document.getElementById("message-seller").style.display = "none";
                  document.getElementById("report-product").style.display = "none";
                  document.getElementById("user-rating-section").style.display =
                    "none";
                }

                console.log(currentUserId);
                const chatUserId = p.user;              
                console.log(currentUserId);           

                          // Fetch product ratings
          fetchProductRatings(id);
        } catch (error) {
          console.error("Error fetching product:", error);
          document.getElementById("product-details").innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-exclamation-triangle text-warning" style="font-size: 48px;"></i>
          <h3 class="mt-3">Product Not Found</h3>
          <p class="text-muted">The product you're looking for doesn't exist or has been removed.</p>
          <a href="list.html" class="btn btn-primary mt-3">Back to Collection</a>
        </div>
      `;
        }
      }

      
      const currentUserId = localStorage.getItem("user_id");      
      console.log(currentUserId);


      const chatUserId = p.user;              
      console.log(currentUserId);           

      // Elements
      const chatEl = document.getElementById("chat");
      const textarea = document.getElementById("message");
      const sendBtn = document.getElementById("sendBtn");
      const clearBtn = document.getElementById("clearHistory");

      // Create a chat bubble
      function createMsg({ role, text }) {
        const msg = document.createElement("div");
        msg.className = `msg ${role}`;
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.innerHTML = role === "user" ? '<i class="bi bi-person"></i>' : '<i class="bi bi-people"></i>';
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerText = text;

        if (role === "user") {
          msg.appendChild(bubble);
          msg.appendChild(avatar);
        } else {
          msg.appendChild(avatar);
          msg.appendChild(bubble);
        }
        chatEl.appendChild(msg);
        chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: "smooth" });
      }




      





      // Load conversation
      async function loadConversation() {
        try {
          const res = await fetch(`${API_BASE}/messages/${chatUserId}`, {
            headers: { Authorization: `Bearer ${TOKEN}` }

          });


          const messages = await res.json();
          chatEl.innerHTML = "";
          messages.forEach(m => {
            createMsg({
              role: m.sender_id === currentUserId ? "user" : "bot",
              text: m.message
            });
          });
        } catch (err) {
          console.error("Failed to load conversation:", err);
        }
      }

      // Send message
      async function sendMessage() {
        const text = textarea.value.trim();
        if (!text) return;

        // Show message instantly on UI
        createMsg({ role: "user", text });
        textarea.value = "";

        try {
          await fetch(`${API_BASE}/messages/${chatUserId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${TOKEN}`
            },
            body: JSON.stringify({ message: text })
          });
        } catch (err) {
          console.error("Failed to send message:", err);
        }
      }

      // Events
      sendBtn.addEventListener("click", sendMessage);
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      clearBtn.addEventListener("click", () => { chatEl.innerHTML = ""; });

      // Initial load + Auto refresh
      loadConversation();
      setInterval(loadConversation, 3000); // refresh every 3s
    </script>

  </body>
</html>
